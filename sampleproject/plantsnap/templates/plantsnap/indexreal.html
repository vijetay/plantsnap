{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PlantSnap Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* small custom styles */
        .sidebar-item:hover { background-color: rgba(255,255,255,0.06); }
        .tag { background: rgba(0,0,0,0.06); padding: 0.25rem 0.5rem; border-radius: 9999px; margin-right: 0.25rem; display:inline-block }
        .water-today { color: #0ea5a4 }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

<!-- Top Header -->
<header class="w-full bg-green-700 text-white p-4 flex items-center justify-between shadow-md">
    <div class="flex items-center space-x-3">
        <div class="text-2xl">ðŸŒ¿</div>
        <div>
            <h1 class="text-xl font-bold">PlantSnap</h1>
            <p class="text-sm opacity-90">Smart Plant Manager</p>
        </div>
    </div>
    <div class="flex items-center space-x-4">
        <div class="hidden md:block text-sm opacity-90">Manage plants â€¢ Care schedules â€¢ Disease detection</div>
        {% if user.is_authenticated %}
        <div class="text-sm">Hello, {{ user.username }}</div>
        <a href="{% url 'logout' %}" class="bg-red-600 px-3 py-1 rounded hover:bg-red-500">Logout</a>
        {% else %}
        <a href="{% url 'login' %}" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500">Login</a>
        <a href="{% url 'register' %}" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500">Sign Up</a>
        {% endif %}
    </div>
</header>

<div class="flex h-[calc(100vh-72px)]"> <!-- header height approx 72px -->

    <!-- Sidebar (left) -->
    <aside class="w-64 bg-white border-r border-gray-200 p-4 flex flex-col">
        <nav class="space-y-2 mt-2">
            <a href="#identify" class="flex items-center p-2 rounded sidebar-item"><i class="ri-search-eye-line mr-2 text-lg"></i>Identify Plant</a>
            <a href="#gallery" class="flex items-center p-2 rounded sidebar-item"><i class="ri-gallery-line mr-2 text-lg"></i>Gallery</a>
            <a href="#care" class="flex items-center p-2 rounded sidebar-item"><i class="ri-time-line mr-2 text-lg"></i>Care Schedule</a>
            <a href="#growth" class="flex items-center p-2 rounded sidebar-item"><i class="ri-bar-chart-line mr-2 text-lg"></i>Growth Tracker</a>
            <a href="#disease" class="flex items-center p-2 rounded sidebar-item"><i class="ri-virus-line mr-2 text-lg"></i>Disease Scan</a>
        </nav>

        <div class="mt-auto text-xs text-gray-500">v1.0 â€¢ Local & Backend</div>
    </aside>

    <!-- Main Content (right) -->
    <main class="flex-1 overflow-y-auto p-6 space-y-6">

        <!-- Plant Identifier (top of main) -->
        <section id="identify" class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="ri-search-eye-line mr-2"></i> Identify Plant</h2>
            <p class="text-gray-600 mb-4">Upload an image to identify plant species. Images are saved in backend and shown in your gallery until you delete them.</p>

            <div class="flex flex-col md:flex-row md:items-center gap-3">
                <input id="plant-files" type="file" multiple accept="image/*" class="border p-2 rounded w-full md:w-auto">
                <button id="btn-upload" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600">Upload & Identify</button>
                <div class="text-sm text-gray-500">Or drag & drop onto this page (works in modern browsers).</div>
            </div>

            <div id="uploadResults" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <!-- Gallery -->
        <section id="gallery" class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="ri-gallery-line mr-2"></i> Your Plant Gallery</h2>
            <div id="plantGallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </section>

        <!-- Care Schedule (with plant image and autoschedule) -->
        <section id="care" class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="ri-time-line mr-2"></i> Care Schedule</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="col-span-2">
                    <div class="flex flex-col md:flex-row gap-3 items-center">
                        <select id="schedulePlantSelect" class="border p-2 rounded flex-1"></select>
                        <input id="scheduleType" placeholder="Task (Water, Fertilize...)" class="border p-2 rounded w-full md:w-60">
                        <input id="scheduleDate" type="date" class="border p-2 rounded w-44">
                        <input id="scheduleInterval" type="number" placeholder="Repeat every (days)" class="border p-2 rounded w-44">
                        <button id="saveSchedule" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600">Save</button>
                    </div>

                    <div class="mt-4" id="scheduleList"></div>
                </div>

                <!-- Plant preview + tags + auto-detection -->
                <div class="p-4 border rounded">
                    <h3 class="font-semibold mb-2">Selected Plant</h3>
                    <div id="selectedPlantPreview" class="mb-3 text-center">
                        <div class="w-full h-40 bg-gray-50 rounded flex items-center justify-center text-gray-400">No plant selected</div>
                    </div>

                    <label class="text-sm">Tags (comma separated)</label>
                    <input id="plantTags" placeholder="flowering, seasonal" class="border p-2 rounded w-full mb-2">

                    <label class="text-sm">Automatic Problem Detection</label>
                    <select id="problemDetect" class="border p-2 rounded w-full mb-2">
                        <option value="">-- Select a symptom --</option>
                        <option value="yellow_leaves">Yellow leaves</option>
                        <option value="brown_tips">Brown tips</option>
                        <option value="droopy">Droopy leaves</option>
                        <option value="spotting">Leaf spots</option>
                    </select>
                    <div id="problemAdvice" class="text-sm text-gray-600"></div>

                </div>
            </div>
        </section>

        <!-- Growth Tracker -->
        <section id="growth" class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="ri-bar-chart-line mr-2"></i> Growth Tracker</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <select id="growthPlantSelect" class="border p-2 rounded"></select>
                <input id="growthDate" type="date" class="border p-2 rounded">
                <input id="growthHeight" type="number" placeholder="Height (cm)" class="border p-2 rounded">
                <button id="addGrowth" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 col-span-1 md:col-span-1">Add</button>
            </div>
            <canvas id="growthChart" height="200"></canvas>
        </section>

        <!-- Disease Detection -->
        <section id="disease" class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-3 flex items-center"><i class="ri-virus-line mr-2"></i> Disease Detection</h2>
            <div class="flex gap-3 items-center">
                <input id="diseaseFile" type="file" accept="image/*" class="border p-2 rounded">
                <button id="btn-disease" class="bg-red-700 text-white px-4 py-2 rounded hover:bg-red-600">Scan Disease</button>
            </div>
            <div id="diseaseResult" class="mt-4"></div>
        </section>

    </main>
</div>

<!-- JS Scripts -->
<script>
// Utility: format date YYYY-MM-DD
function fmt(d) { const x = new Date(d); if (isNaN(x)) return ''; const y=x.getFullYear(), m=('0'+(x.getMonth()+1)).slice(-2), day=('0'+x.getDate()).slice(-2); return `${y}-${m}-${day}` }

// Seasonal adjustments: returns adjusted interval in days
function seasonalAdjustedInterval(baseInterval, dateStr) {
    const date = dateStr ? new Date(dateStr) : new Date();
    const month = date.getMonth() + 1; // 1-12
    // Assume Apr-Sep = warmer months (increase watering frequency -> shorten interval by 25%)
    if (month >=4 && month <=9) return Math.max(1, Math.round(baseInterval * 0.75));
    // Dec-Feb = winter -> lengthen interval by 25%
    if (month ===12 || month <=2) return Math.max(1, Math.round(baseInterval * 1.25));
    return baseInterval;
}

// ---------------------- API helpers ----------------------
async function apiPost(path, formData) {
    try {
        const res = await fetch(path, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Network response not ok');
        return await res.json();
    } catch (e) {
        console.warn('API error', path, e);
        return { error: e.message };
    }
}

async function apiGet(path) {
    try {
        const res = await fetch(path);
        if (!res.ok) throw new Error('Network response not ok');
        return await res.json();
    } catch (e) {
        console.warn('API error', path, e);
        return { error: e.message };
    }
}

// ---------------------- Plant Upload ----------------------
document.getElementById("btn-upload").onclick = async () => {
    const files = document.getElementById("plant-files").files;
    if (!files.length) return alert('Select at least one image');

    const container = document.getElementById('uploadResults');
    container.innerHTML = '<div class="text-sm text-gray-500">Uploading...</div>';

    const results = [];

    for (let f of files) {
        const formData = new FormData();
        formData.append('file', f);
        // Try backend endpoint; expects server to save image and run identification
        const data = await apiPost('/plantsnap/api/upload/', formData);
        if (data && data.results && data.results.length) {
            results.push(...data.results);
        } else if (data && data.error) {
            // fallback: local preview + store in localStorage as 'unsynced'
            const url = URL.createObjectURL(f);
            const pseudo = { image_url: url, common_name: 'Unknown (local)', scientific_name: '', confidence: 0, id: Date.now() };
            results.push(pseudo);
            saveLocalPlant(pseudo, f);
        }
    }

    // render results
    container.innerHTML = '';
    results.forEach(r => renderUploadedCard(r, container));

    await loadGallery();
};

function renderUploadedCard(r, container) {
    const div = document.createElement('div');
    div.className = 'border p-2 rounded';
    div.innerHTML = `<img src="${r.image_url}" class="w-full h-40 object-cover mb-2 rounded">
                     <strong>${r.common_name || 'Unknown'}</strong><br><small class="text-gray-500">${r.scientific_name || ''}</small>
                     <div class="mt-2">Confidence: ${ (r.confidence || 0).toFixed ? (r.confidence||0).toFixed(2) : r.confidence }</div>`;
    container.appendChild(div);
}

// ---------------------- Local storage fallback ----------------------
function getLocalPlants() {
    try { return JSON.parse(localStorage.getItem('plantsnap_plants') || '[]'); } catch(e){ return [] }
}
function saveLocalPlants(arr) { localStorage.setItem('plantsnap_plants', JSON.stringify(arr)); }
function saveLocalPlant(pseudo, file) {
    const arr = getLocalPlants();
    arr.push(Object.assign({}, pseudo));
    saveLocalPlants(arr);
}

// ---------------------- Gallery ----------------------
async function loadGallery() {
    const res = await apiGet('/plantsnap/api/get-images/');
    const container = document.getElementById('plantGallery');

    let results = [];
    if (res && res.results) results = res.results;

    // include local unsynced
    const local = getLocalPlants();
    if (local.length) results = local.concat(results);

    container.innerHTML = '';
    results.forEach(r => {
        const div = document.createElement('div');
        div.className = 'border rounded overflow-hidden shadow-sm';
        div.innerHTML = `<img src="${r.image_url}" class="w-full h-40 object-cover">
                         <div class="p-2">
                             <strong>${r.common_name || 'Unknown'}</strong><br><small class="text-gray-500">${r.scientific_name || ''}</small>
                             <div class="mt-2 flex items-center gap-2">
                                 <button onclick="deleteImage(${r.id || 0})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-400">Delete</button>
                                 <button onclick="selectPlant(${r.id || 0}, this)" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-400">Select</button>
                             </div>
                         </div>`;
        container.appendChild(div);
    });

    // Populate dropdowns for schedule and growth
    const plantSelects = [document.getElementById("schedulePlantSelect"), document.getElementById("growthPlantSelect")];
    plantSelects.forEach(sel => {
        sel.innerHTML = '';
        results.forEach((r, idx) => {
            const name = (r.common_name || r.scientific_name || ('Plant ' + (idx+1))).replace(/\"/g,'');
            const id = r.plant_id || r.id || ('local-' + idx);
            const opt = document.createElement('option');
            opt.value = id;
            opt.text = name;
            sel.appendChild(opt);
        });
    });
}

async function deleteImage(id) {
    if (!confirm('Delete this image?')) return;
    // try backend
    const formData = new FormData(); formData.append('id', id);
    await apiPost('/plantsnap/api/delete-image/', formData);
    // also remove local copies
    let local = getLocalPlants(); local = local.filter(p => (p.id && p.id !== id) ); saveLocalPlants(local);
    await loadGallery();
}

function selectPlant(id, btn) {
    // find in backend or local
    (async () => {
        const res = await apiGet('/plantsnap/api/get-images/');
        let all = (res && res.results) ? res.results : [];
        const local = getLocalPlants(); all = local.concat(all);
        let p = all.find(x => (x.plant_id == id || x.id == id || ('local-' + all.indexOf(x)) == id));
        if (!p) p = all[0];
        if (!p) return alert('No plant found');
        document.getElementById('selectedPlantPreview').innerHTML = `<img src="${p.image_url}" class="w-full h-32 object-cover rounded mb-2"><div class="text-sm"><strong>${p.common_name||'Unknown'}</strong><div class="text-xs text-gray-500">${p.scientific_name||''}</div></div>`;
        document.getElementById('plantTags').value = (p.tags ? p.tags.join(', ') : '');
        // store current selected in session
        sessionStorage.setItem('plantsnap_selected', JSON.stringify(p));
    })();
}

// ---------------------- Care Schedule ----------------------
async function loadSchedule() {
    const res = await apiGet('/plantsnap/api/get-schedule/');
    let schedules = (res && res.results) ? res.results : [];

    // combine local plant schedules if any (not implemented in backend example)
    const container = document.getElementById('scheduleList');
    container.innerHTML = '';

    schedules.forEach(s => {
        const next = computeNextDate(s.date, s.interval_days);
        const adjustedInterval = seasonalAdjustedInterval(s.interval_days, s.date);
        const isWaterToday = isToday(next) && /water/i.test(s.task);

        const div = document.createElement('div');
        div.className = 'border p-2 rounded flex justify-between items-center';
        div.innerHTML = `<div>
            <div class="font-semibold">${s.task} â€¢ ${s.plant_name}</div>
            <div class="text-sm text-gray-600">Added: ${s.date} â€¢ Interval: ${s.interval_days} days (adj: ${adjustedInterval})</div>
            <div class="text-sm">Next: ${fmt(next)}</div>
        </div>
        <div class="text-right">
            <div class="text-sm ${isWaterToday? 'water-today':''}">${isWaterToday ? 'Water Today ðŸ’§' : ''}</div>
            <button onclick="deleteSchedule(${s.id})" class="bg-red-500 text-white px-2 py-1 rounded mt-2">Delete</button>
        </div>`;
        container.appendChild(div);
    });
}

function computeNextDate(startDate, intervalDays) {
    // compute next occurrence from startDate to future based on interval
    const start = new Date(startDate);
    const today = new Date();
    let next = new Date(start);
    if (isNaN(next)) next = new Date();
    while (next < today) next.setDate(next.getDate() + Math.max(1, intervalDays));
    return fmt(next);
}

function isToday(dateStr) {
    const d = new Date(dateStr);
    const t = new Date();
    return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
}

document.getElementById('saveSchedule').onclick = async () => {
    const plant_id = document.getElementById('schedulePlantSelect').value;
    const task = document.getElementById('scheduleType').value.trim();
    const date = document.getElementById('scheduleDate').value;
    const interval = parseInt(document.getElementById('scheduleInterval').value) || 7;
    if (!plant_id || !task || !date) return alert('Fill plant, task and date');

    const formData = new FormData();
    formData.append('plant_id', plant_id);
    formData.append('task', task);
    formData.append('date', date);
    formData.append('interval_days', interval);

    const res = await apiPost('/plantsnap/api/save-schedule/', formData);
    if (res && res.success) {
        await loadSchedule();
    } else {
        alert('Saved locally (backend failed)');
    }
};

async function deleteSchedule(id) {
    if (!confirm('Delete schedule?')) return;
    const formData = new FormData(); formData.append('id', id);
    await apiPost('/plantsnap/api/delete-schedule/', formData);
    await loadSchedule();
}

// ---------------------- Disease Scan ----------------------
document.getElementById('btn-disease').onclick = async () => {
    const file = document.getElementById('diseaseFile').files[0];
    if (!file) return alert('Select a file!');
    const formData = new FormData(); formData.append('file', file);
    const res = await apiPost('/plantsnap/api/disease/', formData);
    const container = document.getElementById('diseaseResult');
    if (res && res.success) {
        container.innerHTML = `<strong>Disease:</strong> ${res.disease} <br>Confidence: ${(res.confidence||0).toFixed(2)}<br>Advice: ${res.advice}`;
    } else if (res && res.error) {
        container.innerHTML = `<span class="text-red-500">Error: ${res.error}</span>`;
    } else {
        container.innerHTML = `<span class="text-gray-600">No result from backend. (Local preview only)</span>`;
    }
};

// ---------------------- Growth Tracker ----------------------
let growthChart = null;

document.getElementById('addGrowth').onclick = async () => {
    const plant_id = document.getElementById('growthPlantSelect').value;
    const date = document.getElementById('growthDate').value;
    const height = parseFloat(document.getElementById('growthHeight').value);
    if (!plant_id || !date || !height) return alert('Fill all fields!');

    const formData = new FormData();
    formData.append('plant_id', plant_id);
    formData.append('date', date);
    formData.append('height_cm', height);
    await apiPost('/plantsnap/api/add-growth/', formData);
    loadGrowthChart();
};

async function loadGrowthChart() {
    const res = await apiGet('/plantsnap/api/get-growth/');
    const data = (res && res.results) ? res.results : [];

    const plants = {};
    data.forEach(r => {
        if (!plants[r.plant_name]) plants[r.plant_name] = [];
        plants[r.plant_name].push({ date: r.date, height: r.height_cm });
    });

    const ctx = document.getElementById('growthChart').getContext('2d');
    if (growthChart) growthChart.destroy();

    const labels = Object.values(plants)[0]?.map(d => d.date) || [];
    const datasets = Object.keys(plants).map((name, i) => ({
        label: name,
        data: plants[name].map(d => d.height),
        borderColor: `hsl(${i*60 % 360}, 70%, 50%)`,
        fill: false,
        tension: 0.2
    }));

    growthChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Height (cm)' } } } }
    });
}

// ---------------------- Problem detection advice ----------------------
const adviceMap = {
    'yellow_leaves': 'Possible overwatering or nutrient deficiency. Check soil moisture and consider reducing water. Add balanced fertilizer if needed.',
    'brown_tips': 'Could be low humidity or salt build-up. Trim damaged tips, flush soil occasionally, increase humidity.',
    'droopy': 'Underwatering or root issues. Check soil moisture; water if dry. Verify drainage.',
    'spotting': 'Could be fungal/bacterial â€” isolate plant, remove affected leaves, consider fungicide for severe cases.'
};

document.getElementById('problemDetect').onchange = function() {
    const v = this.value;
    document.getElementById('problemAdvice').innerText = adviceMap[v] || '';
};

// ---------------------- Initial Load ----------------------
(async function init(){
    await loadGallery();
    await loadSchedule();
    await loadGrowthChart();
})();

</script>


</body>
</html>
